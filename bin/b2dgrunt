#!/bin/bash
set -ex
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

SCRIPT_PARENT_DIR=${0%/*}/..
cd $SCRIPT_PARENT_DIR
VOLUMES=/var/lib/docker/volumes
TARGET=$VOLUMES/mozilla/bedrock
boot2docker init
if [ $(boot2docker status) == "poweroff" ]; then
    boot2docker start
fi
boot2docker ssh "sudo mkdir -p $TARGET && sudo chown -R docker $VOLUMES"
boot2docker ssh "which rsync || tce-load -wi rsync"

#TODO: eliminate settings/local.py in favor of env variables
if [ ! -e bedrock/settings/local.py ]; then
    cp bedrock/settings/local.py-dist bedrock/settings/local.py
fi

RSYNC_ARGS=(
    -e "ssh -i $HOME/.ssh/id_boot2docker"
    -avz
    --exclude .git
    --exclude .svn
    #--exclude-from .gitignore  # this excludes settings/local.py
    . docker@$(boot2docker ip):$TARGET)
rsync "${RSYNC_ARGS[@]}"

if [ ! "$(which fswatch)" ]; then
    if [ $(uname) == "Darwin" ]; then
        if [ ! "$(which brew)" ]; then
            ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
        fi
        brew install fswatch
    else
        echo This script requires fswatch: https://github.com/emcrisostomo/fswatch/blob/master/INSTALL
    fi
fi

fswatch -o . | xargs -n1 -I{} rsync "${RSYNC_ARGS[@]}" &

if [ ! "$(which docker-compose)" ]; then
    curl -L https://github.com/docker/compose/releases/download/1.2.0/docker-compose-`uname -s`-`uname -m` \
         > /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
fi

eval $(boot2docker shellinit)
if [ ! "$(docker images | grep bedrock_b2d)" ]; then
    docker-compose build b2d
fi

if [ ! "$(docker images | grep bedrock_b2dgrunt)" ]; then
    docker-compose build b2dgrunt
fi

docker-compose run b2d bash -c "if [ ! -e .synced ]; then bin/sync_all && touch .synced; fi"
docker-compose up b2d b2dgrunt
