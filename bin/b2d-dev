#!/bin/bash -ex
trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT

SCRIPT_DIR=${0%/*}
$SCRIPT_DIR/b2d-fswatch-rsync
cd $SCRIPT_DIR/..

if [ ! "$(which docker-compose)" ]; then
    curl -L https://github.com/docker/compose/releases/download/1.2.0/docker-compose-`uname -s`-`uname -m` \
         > /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
fi

eval $(boot2docker shellinit)
if [ ! "$(docker images | grep bedrock_b2d)" ]; then
    docker-compose build b2d
fi
docker-compose run b2d bash -c "if [ ! -e .synced ]; then bin/sync_all && touch .synced; fi"
docker-compose up b2d
