name: Post-deploy asset check

run-name: Asset check for ${{ inputs.branch }} @ ${{ inputs.git_sha }}

on:
  workflow_dispatch:
    inputs:
      branch:
        description: Branch of mozilla/bedrock that was deployed (eg. main|stage|prod)
        required: true
      git_sha:
        description: Git SHA that was deployed
        required: true
      origin_hostname:
        description: Fully qualified base URL for the origin server
        required: true
      cdn_hostname:
        description: Fully qualified base URL for the CDN (eg. https://www.mozilla.org)
        required: true

jobs:
  asset-check:
    runs-on: ubuntu-latest
    steps:
      - name: Pull release image
        run: docker pull mozmeao/bedrock:${{ inputs.git_sha }}

      - name: Verify deployed assets are available
        run: |
          docker run --rm \
            mozmeao/bedrock:${{ inputs.git_sha }} \
            python manage.py check_static_assets \
              --origin-host "${{ inputs.origin_hostname }}" \
              --cdn-host "${{ inputs.cdn_hostname }}" \
              --manifest-path static/staticfiles.json
