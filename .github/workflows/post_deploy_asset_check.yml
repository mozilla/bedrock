name: Post-deploy asset check

run-name: Asset check for ${{ inputs.branch }} @ ${{ inputs.git_sha }}

on:
  workflow_dispatch:
    inputs:
      branch:
        description: Branch of mozilla/bedrock that was deployed (eg. main|stage|prod)
        required: true
      git_sha:
        description: Git SHA that was deployed
        required: true
      origin_hostname:
        description: Fully qualified base URL for the origin server
        required: true
      cdn_hostname:
        description: Fully qualified base URL for the CDN (eg. https://www.mozilla.org)
        required: true

jobs:
  asset-check:
    runs-on: ubuntu-latest
    steps:
      - name: Pull release image
        run: docker pull mozmeao/bedrock:${{ inputs.git_sha }}

      - name: Verify deployed assets are available
        env:
          GIT_SHA: ${{ inputs.git_sha }}
          ORIGIN_HOSTNAME: ${{ inputs.origin_hostname }}
          CDN_HOSTNAME: ${{ inputs.cdn_hostname }}
        run: |
          docker run --rm \
            mozmeao/bedrock:$GIT_SHA \
            python manage.py check_static_assets \
              --origin-host "$ORIGIN_HOSTNAME" \
              --cdn-host "$CDN_HOSTNAME" \
              --manifest-path static/staticfiles.json
